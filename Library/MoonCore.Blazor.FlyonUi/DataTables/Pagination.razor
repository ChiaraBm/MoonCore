@using MoonCore.Helpers
@using MoonCore.Models

@typeparam TItem

@code
{
    [CascadingParameter(Name = "DataTable")]
    public DataTable<TItem> DataTable { get; set; }

    /// <summary>
    /// Item source for paginated data
    /// </summary>
    [Parameter] public Func<PaginationOptions, Task<IPagedData<TItem>>> ItemSource { get; set; }
    
    /// <summary>
    /// Page size to use when fetching the items and calculating the page counts. Default: 15
    /// </summary>
    [Parameter] public int PageSize { get; set; } = 15;

    internal PaginationOptions Options;
    internal IPagedData<TItem> PagedData = new PagedData<TItem>();
    
    protected override void OnInitialized()
    {
        Options = new()
        {
            Page = 0,
            PerPage = PageSize
        };
        
        DataTable.ItemSource = LoadAsync;

        DataTable.Footer += ComponentHelper.FromType<PaginationDesign<TItem>>(parameters =>
        {
            parameters.Add("Pagination", this);
        });
    }

    private async Task<TItem[]> LoadAsync()
    {
        PagedData = await ItemSource.Invoke(Options);
        return PagedData.Items;
    }
}
