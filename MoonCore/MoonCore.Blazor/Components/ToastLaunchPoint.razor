@using MoonCore.Blazor.Helpers
@using MoonCore.Blazor.Models
@using MoonCore.Blazor.Services

@inject ToastService ToastService
@inject MoonCoreBlazorConfiguration Configuration

@{
    ToastLaunchItem[] items;

    lock (Items)
        items = Items.ToArray();
}

<div style="z-index: 11; position: fixed; bottom: 0; right: 0; padding: 1rem;">
    @foreach (var item in items)
    {
        <div id="toastLauncher@(item.Id)" class="toast my-2 fade" role="alert">
            @item.Render
        </div>
    }
</div>

@code
{
    private readonly List<ToastLaunchItem> Items = new();
    private int Counter = 1;

    protected override async Task OnInitializedAsync()
    {
        await ToastService.SetLaunchPoint(this);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        ToastLaunchItem[] items;

        lock (Items)
            items = Items.ToArray();

        foreach (var item in items)
        {
            if (item.Initialized)
                continue;

            await ToastService.Show($"toastLauncher{item.Id}");

            Task.Run(async () =>
            {
                await Task.Delay(item.Duration);

                lock (Items)
                {
                    if (Items.Contains(item))
                        Items.Remove(item);
                }

                await InvokeAsync(StateHasChanged);
            });

            item.Initialized = true;
        }
    }

    public async Task Launch<T>(TimeSpan? duration = null, Action<Dictionary<string, object>>? buildAttributes = null) where T : ComponentBase
    {
        var item = new ToastLaunchItem()
        {
            Id = Counter + 0,
            Duration = duration ?? Configuration.Toast.Duration,
            Render = ComponentHelper.FromType<T>(buildAttributes)
        };

        lock (Items)
            Items.Add(item);

        Counter++;

        await InvokeAsync(StateHasChanged);
    }
}